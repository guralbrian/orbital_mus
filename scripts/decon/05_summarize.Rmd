---
title: "Decon and Differential Expression Summary"
author: "Orbital Mus Pipeline"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    theme: flatly
params:
  proj_root: "."
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, warning = TRUE, message = FALSE,
  fig.width = 10, fig.height = 6
)
```

```{r libraries}
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
library(RColorBrewer)
library(pheatmap)
library(jsonlite)
```

```{r load-data}
proj_root <- params$proj_root
cfg <- fromJSON(file.path(proj_root, "scripts", "setup", "config.json"))
proc_dir <- file.path(proj_root, cfg$processed_dir)

refs <- cfg$decon_references
alpha <- cfg$de_alpha

compositions <- lapply(refs, function(ref) {
  read.csv(file.path(proc_dir, "decon", paste0(ref, "_compositions.csv"))) |>
    mutate(reference = ref)
}) |>
  bind_rows()

comparisons <- lapply(refs, function(ref) {
  read.csv(file.path(proc_dir, "models", paste0(ref, "_de_comparison.csv"))) |>
    mutate(reference = ref)
}) |>
  bind_rows()

markers <- lapply(refs, function(ref) {
  read.csv(file.path(proc_dir, "decon", paste0(ref, "_markers.csv"))) |>
    mutate(reference = ref)
}) |>
  bind_rows()

group_pal <- brewer.pal(8, "Set2")
names(group_pal) <- cfg$heart_group_order
```

This report summarizes [MuSiC](https://doi.org/10.1038/s41467-018-08023-x) cell
type deconvolution of ~120 orbital unloading mouse heart samples across
**`r length(refs)` single-cell references**, followed by CLR-adjusted DESeq2
differential expression analysis.

**References:**

- **bulk_decon** — 4 cell types from C57BL/6J left ventricle
  ([Gural et al. 2025](https://doi.org/10.1371/journal.pgen.1011807))
- **mortazavi_general** — 8 major cell types across all strains
  ([IGVF Mortazavi lab](https://pubmed.ncbi.nlm.nih.gov/41478285/))
- **mortazavi_celltype** — 14 granular cell types from the same atlas
- **mortazavi_b6j** — 8 cell types restricted to C57BL/6J samples

Each reference contributes 15 markers per cell type selected by log-fold change.
Deconvolution uses MuSiC defaults; DESeq2 models include CLR-transformed
composition covariates.

Source: [github.com/guralbrian/orbital_mus](https://github.com/guralbrian/orbital_mus)

---

# Cell Type Compositions {.tabset}

```{r comp-tabs, results='asis', fig.width=10, fig.height=7}
for (ref in refs) {
  cat("\n\n##", ref, "\n\n")

  comp_ref <- compositions |> filter(reference == ref)

  # Cell types ordered by descending mean proportion
  cell_order <- comp_ref |>
    group_by(CellType) |>
    summarise(mean_prop = mean(Prop, na.rm = TRUE), .groups = "drop") |>
    arrange(desc(mean_prop)) |>
    pull(CellType)

  # Build a Set2-extended palette for references with >8 cell types
  n_types <- length(cell_order)
  set2_ct <- if (n_types <= 8) {
    brewer.pal(max(3, n_types), "Set2")[seq_len(n_types)]
  } else {
    colorRampPalette(brewer.pal(8, "Set2"))(n_types)
  }
  names(set2_ct) <- cell_order

  # Sort samples within each group by dominant cell type
  sample_order <- comp_ref |>
    group_by(group, sample_id) |>
    slice_max(Prop, n = 1, with_ties = FALSE) |>
    ungroup() |>
    arrange(group, CellType, desc(Prop)) |>
    pull(sample_id)

  comp_ref <- comp_ref |>
    mutate(
      sample_id = factor(sample_id, levels = sample_order),
      group = factor(group, levels = cfg$heart_group_order),
      CellType = factor(CellType, levels = cell_order)
    )

  # Stacked bar chart
  p_bar <- ggplot(comp_ref, aes(x = sample_id, y = Prop, fill = CellType)) +
    geom_col(color = "black", linewidth = 0.1) +
    facet_wrap(~ group, scales = "free_x") +
    scale_fill_manual(values = set2_ct,
                      labels = function(x) str_wrap(x, width = 12)) +
    labs(title = paste0("Cell Type Proportions \u2014 ", ref),
         x = NULL, y = "Proportion", fill = "Cell Type") +
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 90, hjust = 1, size = 4),
      text = element_text(size = 8),
      strip.text = element_text(size = 7),
      panel.grid.minor = element_blank()
    )
  print(p_bar)

  cat("\n\n")

  # Grouped mean bars + jitter
  p_mean <- ggplot(comp_ref, aes(x = group, y = Prop, fill = group)) +
    geom_bar(stat = "summary", fun = mean, width = 0.7,
             color = "black", linewidth = 0.2) +
    geom_jitter(width = 0.15, alpha = 0.5, size = 1) +
    facet_wrap(~ CellType, scales = "free_y") +
    scale_fill_manual(values = group_pal) +
    labs(title = paste0("Mean Proportions by Group \u2014 ", ref),
         x = NULL, y = "Proportion", fill = "Group") +
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 6),
      text = element_text(size = 8),
      legend.position = "none",
      panel.grid.minor = element_blank()
    )
  print(p_mean)

  cat("\n\n")

  # Mean proportions table
  mean_tbl <- comp_ref |>
    group_by(group, CellType) |>
    summarise(mean_prop = mean(Prop, na.rm = TRUE), .groups = "drop") |>
    pivot_wider(names_from = CellType, values_from = mean_prop)
  print(knitr::kable(mean_tbl, digits = 4,
                     caption = paste0("Mean proportions \u2014 ", ref)))

  cat("\n\n")
}
```

---

# Marker Specificity {.tabset}

```{r marker-tabs, results='asis', fig.height=5, fig.width=8}
for (ref in refs) {
  cat("\n\n##", ref, "\n\n")

  mk_ref <- markers |>
    filter(reference == ref) |>
    group_by(celltype) |>
    slice_max(summary.logFC, n = 3, with_ties = FALSE) |>
    ungroup()

  # Genes ordered by cell type grouping
  gene_order <- mk_ref |>
    arrange(celltype, desc(summary.logFC)) |>
    pull(gene) |>
    unique()

  mk_ref <- mk_ref |>
    mutate(
      neg_log10_fdr = -log10(pmax(FDR, 1e-300)),
      gene = factor(gene, levels = gene_order)
    )

  p_dot <- ggplot(mk_ref, aes(x = gene, y = celltype,
                               size = summary.logFC, color = neg_log10_fdr)) +
    geom_point() +
    scale_color_viridis_c(option = "magma", name = "-log10(FDR)") +
    scale_size_continuous(name = "logFC", range = c(1, 6)) +
    labs(title = paste0("Top Markers \u2014 ", ref), x = NULL, y = NULL) +
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 8),
      axis.text.y = element_text(size = 8),
      text = element_text(size = 8),
      panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
      panel.grid.minor = element_blank()
    )
  print(p_dot)

  cat("\n\n")
}
```

---

# Reference Comparison

## Mean Proportions Across References

```{r ref-dotplot, fig.height=8}
mean_across <- compositions |>
  group_by(reference, CellType) |>
  summarise(mean_prop = mean(Prop, na.rm = TRUE), .groups = "drop")

ggplot(mean_across, aes(x = CellType, y = mean_prop, color = reference)) +
  geom_point(size = 3, position = position_dodge(width = 0.5)) +
  facet_wrap(~ reference, scales = "free_x", ncol = 1) +
  scale_color_brewer(palette = "Set2") +
  labs(title = "Mean Cell Type Proportions by Reference",
       x = NULL, y = "Mean Proportion") +
  theme_minimal(base_size = 10) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    text = element_text(size = 8),
    panel.grid.minor = element_blank()
  )
```

## Shannon Diversity Correlation

```{r shannon-heatmap, fig.height=5, fig.width=6}
shannon <- function(p) {
  p <- p[p > 0]
  -sum(p * log(p))
}

diversity <- compositions |>
  group_by(reference, sample_id) |>
  summarise(H = shannon(Prop), .groups = "drop") |>
  pivot_wider(names_from = reference, values_from = H)

div_mat <- as.matrix(diversity[, -1])
rownames(div_mat) <- diversity$sample_id

div_cor <- cor(div_mat, use = "pairwise.complete.obs")

pheatmap(div_cor,
         display_numbers = TRUE, number_format = "%.3f",
         main = "Shannon Diversity Correlation Across References",
         fontsize = 10)
```

---

# Differential Expression Summary {.tabset}

## Significant Gene Counts

```{r de-summary-table}
main_effects <- c("HU_vs_NL_MAIN_EFFECT", "IR_vs_Sham_MAIN_EFFECT",
                  "KMP_vs_Sham_MAIN_EFFECT")

sig_summary <- comparisons |>
  group_by(reference, contrast) |>
  summarise(
    n_sig_adj   = sum(padj.adj <= alpha, na.rm = TRUE),
    n_sig_unadj = sum(padj.unadj <= alpha, na.rm = TRUE),
    n_adj_only  = sum(adj_only_sig, na.rm = TRUE),
    n_unadj_only = sum(unadj_only_sig, na.rm = TRUE),
    n_both      = sum(both_sig, na.rm = TRUE),
    .groups = "drop"
  )

knitr::kable(sig_summary, caption = "Significant genes per contrast and reference")
```

## Volcano Plots (Main Effects)

```{r volcano, fig.height=10, fig.width=12}
volcano_data <- comparisons |>
  filter(contrast %in% main_effects) |>
  mutate(
    sig_adj = padj.adj <= alpha,
    neg_log10_p = -log10(pmax(padj.adj, 1e-300))
  )

ggplot(volcano_data, aes(x = log2FoldChange.adj, y = neg_log10_p, color = sig_adj)) +
  geom_point(size = 0.3, alpha = 0.5) +
  geom_hline(yintercept = -log10(alpha), linetype = "dashed", color = "grey40") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey40") +
  scale_color_manual(values = c("FALSE" = "#999999", "TRUE" = "#ed9209"),
                     labels = c("NS", "Sig")) +
  facet_grid(contrast ~ reference) +
  labs(title = "Volcano Plots: Main Effects (Composition-Adjusted)",
       x = "log2 Fold Change", y = "-log10(padj)", color = NULL) +
  theme_minimal(base_size = 10) +
  theme(
    strip.text = element_text(size = 7),
    text = element_text(size = 8),
    panel.grid.minor = element_blank()
  )
```

## Composition Adjustment Impact

```{r adj-impact, fig.height=6}
set2_3 <- brewer.pal(3, "Set2")

impact <- comparisons |>
  group_by(reference, contrast) |>
  summarise(
    adj_only   = sum(adj_only_sig, na.rm = TRUE),
    unadj_only = sum(unadj_only_sig, na.rm = TRUE),
    both       = sum(both_sig, na.rm = TRUE),
    .groups = "drop"
  ) |>
  pivot_longer(cols = c(adj_only, unadj_only, both),
               names_to = "category", values_to = "n_genes")

ggplot(impact, aes(x = contrast, y = n_genes, fill = category)) +
  geom_col(position = "dodge") +
  facet_wrap(~ reference, ncol = 2) +
  scale_fill_manual(values = c(adj_only = set2_3[1], unadj_only = set2_3[2],
                               both = set2_3[3])) +
  labs(title = "Impact of Composition Adjustment on DE Significance",
       x = NULL, y = "Number of genes", fill = NULL) +
  theme_minimal(base_size = 10) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 6),
    text = element_text(size = 8),
    panel.grid.minor = element_blank()
  )
```

---

# Session Info

```{r session-info}
sessionInfo()
```
